{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="max-w-3xl mx-auto mt-10 bg-white p-8 rounded-2xl shadow-lg">
  <h1 class="text-3xl font-bold text-blue-700 mb-6 text-center">ðŸ§º Form Pemesanan Laundry</h1>

  <form method="post">
    {% csrf_token %}

    <!-- Pilih layanan -->
    <div class="mb-5">
      <label class="block text-gray-700 font-medium mb-2">Pilih Layanan</label>
      <select id="serviceSelect" name="service" required
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400">
        <option value="">-- Pilih Layanan --</option>
        {% for s in services %}
        <option value="{{ s.id }}" data-price="{{ s.price }}" data-type="{{ s.type }}">
          {{ s.name }} - Rp{{ s.price }} ({{ s.get_type_display }})
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Pilih item laundry -->
    <div id="itemFields" class="mb-5 hidden">
      <label class="block text-gray-700 font-medium mb-2">Pilih Item Laundry</label>
      <div id="itemList"></div>
      <button type="button" id="addItem" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm mt-2">
        + Tambah Item
      </button>
    </div>

    <!-- Per kilo -->
    <div id="weightField" class="mb-5 hidden">
      <label class="block text-gray-700 font-medium mb-2">Berat (Kg)</label>
      <input type="number" id="weightInput" name="weight" min="1" step="0.1" placeholder="Masukkan berat"
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400">
    </div>

    <!-- Total -->
    <div class="mb-5">
      <label class="block text-gray-700 font-medium mb-2">Total Harga</label>
      <input type="text" id="totalPrice" name="total_price" readonly
        class="w-full border border-gray-300 bg-gray-100 rounded-lg px-4 py-2">
    </div>

    <!-- Alamat penjemputan -->
    <div class="mb-5">
      <label class="block text-gray-700 font-medium mb-2">Alamat Penjemputan</label>
      <textarea name="pickup_address" id="pickup_address" rows="3" required
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400"></textarea>
    </div>

    <!-- Peta lokasi -->
    <div id="map" class="relative z-0 w-full h-64 rounded-lg mb-5 border border-gray-300 overflow-hidden"></div>

    <!-- Jadwal Penjemputan -->
    <div class="mb-5">
      <label class="block text-gray-700 font-medium mb-2">Jadwal Penjemputan</label>
      <input type="datetime-local" name="scheduled_pickup" required
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400">
    </div>

    <!-- Metode Pembayaran -->
    <div>
      <label class="block text-gray-700 mb-1">Metode Pembayaran</label>
      <select name="payment_method" class="w-full border rounded-md p-2" required>
        <option value="">-- Pilih Metode Pembayaran --</option>
        <option value="cod">Bayar di Tempat (COD / Tunai)</option>
        <option value="qris">QRIS / Pembayaran Online</option>
      </select>
    </div>

    <div class="text-center mt-5">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-all duration-300">
        Kirim Pesanan
      </button>
    </div>
  </form>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const serviceSelect = document.getElementById("serviceSelect");
  const itemFields = document.getElementById("itemFields");
  const weightField = document.getElementById("weightField");
  const totalPrice = document.getElementById("totalPrice");
  const weightInput = document.getElementById("weightInput");
  const itemList = document.getElementById("itemList");
  const addItemBtn = document.getElementById("addItem");
  const addressField = document.getElementById("pickup_address");

  const laundryItems = [
    {% for item in laundry_items %}
    { name: "{{ item.name }}", price: {{ item.price }} },
    {% endfor %}
  ];

  function createItemRow() {
    const row = document.createElement("div");
    row.className = "flex items-center mb-2 space-x-2 item-row";

    const select = document.createElement("select");
    select.name = "item_name[]";
    select.className = "item-type border border-gray-300 rounded-lg px-3 py-2 w-1/2";
    select.innerHTML = `<option value="">-- Pilih Item --</option>` +
      laundryItems.map(i => `<option value="${i.name}" data-price="${i.price}">${i.name} - Rp${i.price}</option>`).join('');

    const qty = document.createElement("input");
    qty.type = "number";
    qty.name = "item_qty[]";
    qty.value = 1;
    qty.min = 1;
    qty.className = "item-qty border border-gray-300 rounded-lg px-3 py-2 w-20 text-center";

    const subtotal = document.createElement("span");
    subtotal.className = "item-subtotal text-gray-700 font-semibold w-24 text-right";
    subtotal.textContent = "Rp0";

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "remove-item text-red-500 hover:text-red-700 font-bold px-2";
    removeBtn.textContent = "âœ–";

    row.append(select, qty, subtotal, removeBtn);
    itemList.appendChild(row);
  }

  addItemBtn.addEventListener("click", createItemRow);

  function updateTotal() {
    let total = 0;

    if (!itemFields.classList.contains("hidden")) {
      document.querySelectorAll(".item-row").forEach(row => {
        const select = row.querySelector(".item-type");
        const qtyInput = row.querySelector(".item-qty");
        const subtotalEl = row.querySelector(".item-subtotal");

        const price = parseFloat(select.selectedOptions[0]?.dataset.price || 0);
        const qty = parseInt(qtyInput.value || 0);
        const subtotal = price * qty;
        subtotalEl.textContent = `Rp${subtotal.toLocaleString()}`;
        total += subtotal;
      });
      // Tambahkan harga layanan
      const servicePrice = parseFloat(serviceSelect.options[serviceSelect.selectedIndex]?.dataset.price || 0);
      total += servicePrice;
    }

    if (!weightField.classList.contains("hidden")) {
      const price = parseFloat(serviceSelect.options[serviceSelect.selectedIndex]?.dataset.price || 0);
      const weight = parseFloat(weightInput.value || 0);
      total += price * weight;
    }

    totalPrice.value = `Rp${total.toLocaleString()}`;
  }

  itemList.addEventListener("input", updateTotal);
  itemList.addEventListener("change", updateTotal);
  weightInput.addEventListener("input", updateTotal);

  serviceSelect.addEventListener("change", () => {
    const selectedType = serviceSelect.options[serviceSelect.selectedIndex]?.dataset.type;
    itemFields.classList.toggle("hidden", selectedType !== "per_item");
    weightField.classList.toggle("hidden", selectedType !== "per_kilo");

    if (selectedType === "per_item" && itemList.children.length === 0) createItemRow();
    updateTotal();
  });

  itemList.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-item")) {
      e.target.closest(".item-row").remove();
      updateTotal();
    }
  });

  // Inisialisasi peta
  const map = L.map('map').setView([-6.200000, 106.816666], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker;
  function updateLocation(lat, lng) {
    // Update marker
    if (marker) marker.setLatLng([lat, lng]);
    else marker = L.marker([lat, lng]).addTo(map);
    map.setView([lat, lng], 15);

    // Reverse geocoding pakai Nominatim
    fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
        .then(response => response.json())
        .then(data => {
            if (data.display_name) {
                addressField.value = data.display_name; // alamat lengkap
            } else {
                addressField.value = `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;
            }
        })
        .catch(err => {
            console.log("Gagal mendapatkan alamat:", err);
            addressField.value = `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;
        });
}

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => updateLocation(pos.coords.latitude, pos.coords.longitude),
      () => console.log("Gagal mendapatkan lokasi otomatis.")
    );
  }

  map.on('click', e => updateLocation(e.latlng.lat, e.latlng.lng));
});
</script>
{% endblock %}
