{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50 p-8">
  <h1 class="text-4xl font-bold text-blue-700 mb-10 text-center tracking-tight">
    üìä Admin Dashboard
  </h1>

  <!-- Statistik Utama -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-12">
    <div class="bg-white p-6 rounded-2xl shadow-lg text-center border-t-4 border-blue-500 hover:shadow-xl transition-all duration-300">
      <h2 class="text-sm font-semibold text-gray-500 uppercase">Total Layanan</h2>
      <p class="text-3xl font-bold text-blue-600 mt-2">{{ total_services }}</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-lg text-center border-t-4 border-green-500 hover:shadow-xl transition-all duration-300">
      <h2 class="text-sm font-semibold text-gray-500 uppercase">Total Pesanan</h2>
      <p class="text-3xl font-bold text-green-600 mt-2">{{ total_orders }}</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-lg text-center border-t-4 border-indigo-500 hover:shadow-xl transition-all duration-300">
      <h2 class="text-sm font-semibold text-gray-500 uppercase">Total Pengguna</h2>
      <p class="text-3xl font-bold text-indigo-600 mt-2">{{ total_users }}</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-lg text-center border-t-4 border-purple-500 hover:shadow-xl transition-all duration-300">
      <h2 class="text-sm font-semibold text-gray-500 uppercase">Total Kurir</h2>
      <p class="text-3xl font-bold text-purple-600 mt-2">{{ total_couriers }}</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-lg text-center border-t-4 border-yellow-500 hover:shadow-xl transition-all duration-300">
      <h2 class="text-sm font-semibold text-gray-500 uppercase">Pendapatan Bulan Ini</h2>
      <p class="text-3xl font-bold text-yellow-600 mt-2">Rp {{ total_income|floatformat:0 }}</p>
    </div>
  </div>

  <!-- Tombol Aksi -->
  <div class="flex flex-wrap justify-end mb-8 gap-3">
    <a href="{% url 'services:add_service' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow transition">+ Layanan</a>
    <a href="{% url 'orders:add_laundry_item' %}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow transition">+ Item</a>
    <a href="{% url 'accounts:manage_users' %}" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 shadow transition">Akun</a>
  </div>

  <!-- Grafik & Pendapatan -->
  <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
      <div>
        <h2 class="text-2xl font-semibold text-gray-700 mb-2">üí∞ Laporan Pendapatan</h2>
        <p class="text-gray-500">Total Transaksi:
          <span class="font-semibold text-gray-700">{{ total_transactions }}</span>
        </p>
        <p class="text-gray-500">Pendapatan Hari Ini:
          <span class="font-semibold text-green-600">Rp {{ today_income|floatformat:0 }}</span>
        </p>
      </div>
    </div>

    <div class="w-full h-72">
      <canvas id="incomeChart"></canvas>
    </div>
  </div>

  <!-- Script Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('incomeChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(37, 99, 235, 0.5)');
    gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ income_chart_labels|safe }},
        datasets: [{
          label: 'Pendapatan (Rp)',
          data: {{ income_chart_data|safe }},
          fill: true,
          backgroundColor: gradient,
          borderColor: '#2563EB',
          borderWidth: 3,
          tension: 0.35,
          pointRadius: 5,
          pointHoverRadius: 8,
          pointBackgroundColor: '#2563EB',
          pointHoverBackgroundColor: '#1E40AF',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(17, 24, 39, 0.9)',
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            cornerRadius: 8,
            padding: 10,
            callbacks: {
              label: (ctx) => 'Rp ' + ctx.formattedValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.')
            }
          }
        },
        scales: {
          x: { grid: { display: false }, ticks: { color: '#6B7280' } },
          y: {
            grid: { color: '#E5E7EB' },
            ticks: {
              color: '#6B7280',
              callback: (value) => 'Rp ' + value.toLocaleString('id-ID')
            }
          }
        },
        animation: { duration: 1200, easing: 'easeOutQuart' }
      }
    });
  </script>

  <!-- Pesanan Terbaru -->
  <div class="bg-white p-8 rounded-2xl shadow-lg overflow-x-auto mb-12">
    <h2 class="text-2xl font-semibold mb-4 text-gray-700">üß∫ Pesanan Terbaru</h2>
    <p class="text-sm text-gray-500 mb-3">Menampilkan halaman {{ recent_orders.number }} dari {{ recent_orders.paginator.num_pages }}</p>
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-gray-100 text-gray-600">
        <tr>
          <th class="px-4 py-2 text-left">ID</th>
          <th class="px-4 py-2 text-left">Pelanggan</th>
          <th class="px-4 py-2 text-left">Layanan</th>
          <th class="px-4 py-2 text-left">Total</th>
          <th class="px-4 py-2 text-left">Status Pengantaran</th>
          <th class="px-4 py-2 text-left">Status Pembayaran</th>
          <th class="px-4 py-2 text-left">Kurir</th>
          <th class="px-4 py-2 text-left">Tanggal</th>
          <th class="px-4 py-2 text-center">Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% for order in recent_orders %}
        <tr class="border-t hover:bg-blue-50 transition">
          <td class="px-4 py-2 font-semibold text-gray-700">#{{ order.id }}</td>
          <td class="px-4 py-2">{{ order.customer.username }}</td>
          <td class="px-4 py-2">{{ order.service.name }}</td>
          <td class="px-4 py-2 text-gray-800 font-medium">Rp{{ order.price_total|floatformat:0 }}</td>

          <!-- Status Pengantaran -->
          <td class="px-4 py-2">
            <span class="px-3 py-1 rounded-full text-xs font-semibold
              {% if order.order_status == 'pending' %} bg-yellow-100 text-yellow-700
              {% elif order.order_status == 'picked_up' %} bg-blue-100 text-blue-700
              {% elif order.order_status == 'processing' %} bg-indigo-100 text-indigo-700
              {% elif order.order_status == 'ready' %} bg-teal-100 text-teal-700
              {% elif order.order_status == 'delivered' %} bg-green-100 text-green-700
              {% elif order.order_status == 'cancelled' %} bg-red-100 text-red-700
              {% else %} bg-gray-100 text-gray-600 {% endif %}">
              {{ order.get_order_status_display }}
            </span>
          </td>

          <!-- Status Pembayaran -->
          <td class="px-4 py-2">
            {% if order.payment_status == 'paid' %}
              <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">Dibayar</span>
            {% else %}
              <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-semibold">Belum Bayar</span>
            {% endif %}
          </td>

          <td class="px-4 py-2">
            {% if order.assigned_courier %}
              <span class="text-sm font-medium text-blue-700">{{ order.assigned_courier.username }}</span>
            {% else %}
              <span class="text-sm text-gray-400 italic">Belum ditugaskan</span>
            {% endif %}
          </td>
          <td class="px-4 py-2 text-gray-500 text-sm">{{ order.created_at|date:"d M Y, H:i" }}</td>

          <!-- Aksi -->
          <td class="px-4 py-2 text-center">
            <div class="flex items-center justify-center gap-1">
              <!-- Update Status Pengantaran -->
              <form action="{% url 'orders:update_order_status' order.id %}" method="post" class="flex gap-1">
                {% csrf_token %}
                <select name="order_status" class="border border-gray-300 rounded-md text-xs px-1 py-1">
                  {% for value, label in order.ORDER_STATUS_CHOICES %}
                    <option value="{{ value }}" {% if order.order_status == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded-md text-xs shadow">‚úèÔ∏è</button>
              </form>

              <!-- Update Status Pembayaran -->
              <form action="{% url 'orders:update_payment_status' order.id %}" method="post" class="flex gap-1">
                {% csrf_token %}
                <select name="payment_status" class="border border-gray-300 rounded-md text-xs px-1 py-1">
                  {% for value, label in order.PAYMENT_STATUS_CHOICES %}
                    <option value="{{ value }}" {% if order.payment_status == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded-md text-xs shadow">üí≥</button>
              </form>

              <!-- Assign Kurir -->
              <form action="{% url 'orders:assign_courier' order.id %}" method="post" class="flex gap-1">
                {% csrf_token %}
                <select name="courier" class="border border-gray-300 rounded-md text-xs px-1 py-1">
                  <option value="">--</option>
                  {% for courier in couriers %}
                    <option value="{{ courier.id }}" {% if order.assigned_courier == courier %}selected{% endif %}>{{ courier.username }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded-md text-xs shadow">üöö</button>
              </form>

              <!-- Hapus Order -->
              <form action="{% url 'orders:delete_order' order.id %}" method="post">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('Yakin ingin menghapus pesanan ini?')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-md text-xs shadow">üóëÔ∏è</button>
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9" class="text-center py-4 text-gray-500">Belum ada pesanan.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination Orders -->
    <div class="mt-4 flex justify-center space-x-2">
      {% if recent_orders.has_previous %}
      <a href="?orders_page={{ recent_orders.previous_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&laquo; Sebelumnya</a>
      {% endif %}

      {% for num in recent_orders.paginator.page_range %}
        {% if num == recent_orders.number %}
          <span class="px-3 py-1 bg-blue-600 text-white rounded">{{ num }}</span>
        {% elif num >= recent_orders.number|add:-2 and num <= recent_orders.number|add:2 %}
          <a href="?orders_page={{ num }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">{{ num }}</a>
        {% endif %}
      {% endfor %}

      {% if recent_orders.has_next %}
      <a href="?orders_page={{ recent_orders.next_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Berikutnya &raquo;</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
