{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="min-h-screen bg-gray-100 p-6">

  <!-- Header -->
  <div class="mb-6 text-center">
    <h1 class="text-3xl font-bold text-blue-600">
      Dashboard Kurir
    </h1>
    <p class="text-gray-600 mt-2">
      Selamat datang, <b>{{ user.username }}</b>
    </p>
  </div>

  <!-- Tabs -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <div class="flex gap-4 border-b">
      <button class="tab-btn active" data-tab="tab-dashboard">Dashboard</button>
      <button class="tab-btn" data-tab="tab-active">Order Aktif</button>
      <button class="tab-btn" data-tab="tab-history">Riwayat</button>
    </div>
  </div>

  <!-- ================= DASHBOARD ================= -->
  <div id="tab-dashboard" class="tab-content">

    <!-- Statistik Utama -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="stat-card">
        <p class="stat-title">Paket Hari Ini</p>
        <p class="stat-value">{{ stats.daily }}</p>
      </div>
      <div class="stat-card">
        <p class="stat-title">Paket Mingguan</p>
        <p class="stat-value">{{ stats.weekly }}</p>
      </div>
      <div class="stat-card">
        <p class="stat-title">Paket Bulanan</p>
        <p class="stat-value">{{ stats.monthly }}</p>
      </div>
    </div>

    <!-- Ringkasan -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">

      <div class="info-card bg-blue-50">
        <p class="info-title">Order Aktif</p>
        <p class="info-value text-blue-600">{{ orders|length }}</p>
      </div>

      <div class="info-card bg-yellow-50">
        <p class="info-title">COD Belum Dibayar</p>
        <p class="info-value text-yellow-600">
          {{ orders|dictsort:"payment_status"|length }}
        </p>
      </div>

      <div class="info-card bg-green-50">
        <p class="info-title">Order Selesai</p>
        <p class="info-value text-green-600">{{ completed_orders|length }}</p>
      </div>

      <div class="info-card bg-purple-50">
        <p class="info-title">Status Kurir</p>
        <p class="info-value text-purple-600">Aktif</p>
      </div>

    </div>

    <!-- Progress -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="font-semibold mb-2">Progress Pengantaran Hari Ini</h3>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div class="bg-blue-600 h-4 rounded-full transition-all duration-500"
            style="width: {{ stats.progress }}%">
        </div>
      </div>

      <p class="text-sm text-gray-500 mt-2">
        {{ stats.daily }} / {{ stats.target }} paket ({{ stats.progress }}%)
      </p>
    </div>

    <!-- Highlight Order Terbaru -->
    <div class="bg-white rounded-xl shadow p-6">
      <h3 class="font-semibold mb-4">Order Terbaru</h3>

      {% if orders %}
      <div class="border rounded-lg p-4 flex justify-between items-center">
        <div>
          <p class="font-semibold">
            {{ orders.0.customer.username }}
          </p>
          <p class="text-sm text-gray-500">
            {{ orders.0.pickup_address }}
          </p>
        </div>
        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
          {{ orders.0.order_status|capfirst }}
        </span>
      </div>
      {% else %}
      <p class="text-gray-500">Tidak ada order terbaru.</p>
      {% endif %}
    </div>

  </div>

  <!-- ================= ORDER AKTIF ================= -->
  <div id="tab-active" class="tab-content hidden">

    <div class="bg-white rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">Order Aktif</h2>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="th">ID</th>
              <th class="th">Customer</th>
              <th class="th">Alamat</th>
              <th class="th">Service</th>
              <th class="th">Total</th>
              <th class="th">Status</th>
              <th class="th">Kontak</th>
              <th class="th text-center">Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
            <tr class="border-t hover:bg-blue-50">
              <td class="td">{{ o.id }}</td>
              <td class="td">{{ o.customer.username }}</td>
              <td class="td">{{ o.pickup_address }}</td>
              <td class="td">{{ o.service.name }}</td>
              <td class="td">Rp {{ o.price_total|floatformat:0 }}</td>
              <td class="td capitalize">{{ o.order_status }}</td>
              <td class="td flex gap-2">
                {% if o.latitude and o.longitude %}
                <a href="https://www.google.com/maps/search/?api=1&query={{ o.latitude }},{{ o.longitude }}" target="_blank" class="link-blue">Maps</a>
                {% endif %}
                {% if o.customer.phone %}
                {% with o.customer.phone|slice:"1:" as wa %}
                <a href="https://wa.me/62{{ wa }}" target="_blank" class="link-green">WA</a>
                {% endwith %}
                {% endif %}
              </td>
              <td class="td text-center space-x-1">

                {% if o.order_status == 'pending' %}
                <a href="{% url 'courier:update_status' o.id 'pickup' %}" class="btn-yellow">Ambil</a>
                {% elif o.order_status == 'pickup' %}
                <a href="{% url 'courier:update_status' o.id 'in_progress' %}" class="btn-blue">Antar</a>
                {% elif o.order_status == 'in_progress' %}
                <a href="{% url 'courier:update_status' o.id 'delivered' %}" class="btn-green">Selesai</a>
                {% endif %}

                {% if o.payment_method == 'cod' and o.payment_status == 'unpaid' %}
                <a href="{% url 'courier:mark_cod_paid' o.id %}" class="btn-dark">Bayar</a>
                {% endif %}

              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-4 text-gray-500">
                Tidak ada order aktif
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- ================= RIWAYAT ================= -->
  <div id="tab-history" class="tab-content hidden">

    <div class="bg-white rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">Riwayat Paket</h2>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="th">ID</th>
              <th class="th">Customer</th>
              <th class="th">Payment</th>
              <th class="th">Metode</th>
              <th class="th">Service</th>
              <th class="th">Total</th>
              <th class="th">Tanggal</th>
            </tr>
          </thead>
          <tbody>
            {% for r in completed_orders %}
            <tr class="border-t hover:bg-green-50">
              <td class="td">{{ r.id }}</td>
              <td class="td">{{ r.customer.username }}</td>
              <td class="td">{{ r.payment_status }}</td>
              <td class="td">{{ r.payment_method|upper }}</td>
              <td class="td">{{ r.service.name }}</td>
              <td class="td">Rp {{ r.price_total|floatformat:0 }}</td>
              <td class="td">{{ r.updated_at|date:"d M Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-4 text-gray-500">
                Belum ada riwayat
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>

</div>

<!-- ================= STYLE ================= -->
<style>
  .tab-btn {
    padding: 10px 16px;
    font-weight: 600;
    color: #6b7280;
    border-bottom: 3px solid transparent;
  }
  .tab-btn.active {
    color: #2563eb;
    border-color: #2563eb;
  }
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,.05);
  }
  .stat-title {
    color: #6b7280;
    font-size: 14px;
  }
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #2563eb;
    margin-top: 6px;
  }
  .info-card {
    padding: 16px;
    border-radius: 16px;
    text-align: center;
  }
  .info-title {
    font-size: 13px;
    color: #6b7280;
  }
  .info-value {
    font-size: 26px;
    font-weight: bold;
    margin-top: 6px;
  }
</style>
<!-- ================= STYLE ================= -->
<style>
  .tab-btn {
    padding: 10px 16px;
    font-weight: 600;
    color: #6b7280;
    border-bottom: 3px solid transparent;
  }
  .tab-btn.active {
    color: #2563eb;
    border-color: #2563eb;
  }
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 5px 15px rgba(0,0,0,.05);
    text-align: center;
  }
  .stat-title {
    color: #6b7280;
    font-size: 14px;
  }
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #2563eb;
    margin-top: 8px;
  }
  .th { padding: 10px; text-align: left; }
  .td { padding: 10px; }
  .btn-yellow { background:#f59e0b;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;}
  .btn-blue { background:#3b82f6;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;}
  .btn-green { background:#22c55e;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;}
  .btn-dark { background:#111827;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;}
  .link-blue { color:#2563eb;font-weight:500; }
  .link-green { color:#16a34a;font-weight:500; }
</style>

<!-- ================= SCRIPT ================= -->
<script>
  const tabs = document.querySelectorAll('.tab-btn');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      contents.forEach(c => c.classList.add('hidden'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.remove('hidden');
    });
  });
</script>

{% endblock %}
